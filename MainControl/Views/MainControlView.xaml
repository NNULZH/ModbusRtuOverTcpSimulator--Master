<UserControl x:Class="MainControl.Views.MainControlView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:MainControl.Views"
             xmlns:Core ="clr-namespace:Core;assembly=Core"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="420" d:DesignWidth="650"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             prism:ViewModelLocator.AutoWireViewModel="True" >
    <!--这部分是主控部分-->
    <!--显示轮询结果放在另一个项目,这里先不提-->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.5*"/>
            <ColumnDefinition Width="1.5*"/>
        </Grid.ColumnDefinitions>
        <Grid Grid.Column="0" Background="#FDFDFD">
            <StackPanel Margin="10" VerticalAlignment="Top">

                <TextBlock Text="任务配置" 
                   FontSize="16" 
                   FontWeight="Bold" 
                   Margin="0,0,0,15"
                   Foreground="#333"/>

                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="35"/>
                        <RowDefinition Height="35"/>
                        <RowDefinition Height="35"/>
                        <RowDefinition Height="35"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="从站 ID:" VerticalAlignment="Center" Foreground="#555"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding InputSlaveId,Mode=TwoWay}" VerticalContentAlignment="Center" Height="26"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="功能码:" VerticalAlignment="Center" Foreground="#555"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding InputFunctionCode,Mode=TwoWay}" VerticalContentAlignment="Center" Height="26"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="起始地址:" VerticalAlignment="Center" Foreground="#555"/>
                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding InputStartAddress,Mode=TwoWay}" VerticalContentAlignment="Center" Height="26"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="读取数量:" VerticalAlignment="Center" Foreground="#555"/>
                    <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding InputCount,Mode=TwoWay}" VerticalContentAlignment="Center" Height="26"/>
                </Grid>

                <Button Content="➕ 添加到队列" 
                Command="{Binding AddTaskCommand}"
                Height="35" 
                Margin="0,0,0,20"
                Background="#0078D7" Foreground="White" BorderThickness="0"/>

                <Separator Margin="0,0,0,20"/>

                <TextBlock Text="轮询控制" FontWeight="Bold" Margin="0,0,0,10" Foreground="#333"/>

                <Button Content="▶ 开始轮询" 
                Command="{Binding StartPollingCommand}"
                Height="40" 
                Margin="0,0,0,10"
                Background="#4CAF50" Foreground="White" FontWeight="Bold" BorderThickness="0"/>

                <Button Content="⏹ 停止轮询" 
                Command="{Binding StopPollingCommand}"
                Height="40" 
                Background="#F44336" Foreground="White" FontWeight="Bold" BorderThickness="0"/>

            </StackPanel>
        </Grid>
        <Grid Grid.Column="1">
            <DataGrid ItemsSource="{Binding Commands}"
              SelectedItem ="{Binding SelectedCommand}"
              AutoGenerateColumns="False"
              CanUserAddRows="False"
              CanUserDeleteRows="False"
              SelectionMode="Single"
              SelectionUnit="FullRow"
              IsReadOnly="False"
              HeadersVisibility="Column"
              GridLinesVisibility="All"
              BorderThickness="1"
              BorderBrush="#FFABADB3"
              Background="White"
              RowHeight="25"
              Margin="5">

                <DataGrid.Resources>
                    <Core:ByteArrayToHexStringConverter x:Key="ByteArrayToHexStringConverter"/>
                </DataGrid.Resources>

                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Setter Property="Tag" Value="{Binding DataContext,RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                        <Setter Property="ContextMenu">
                            <Setter.Value>
                                <ContextMenu>
                                    <MenuItem Header="Send" Command="{Binding PlacementTarget.Tag.SendCommand,RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                              CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                    <MenuItem Header="Delete" Command="{Binding PlacementTarget.Tag.DeleteCommand,RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                              CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                </ContextMenu>
                            </Setter.Value>
                        </Setter>
                    </Style>

                </DataGrid.RowStyle>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Slave ID" 
                                Binding="{Binding SlaveId, Mode=TwoWay}" 
                                Width="80"/>

                    <DataGridTextColumn Header="Func" 
                                Binding="{Binding FuncCode, Mode=TwoWay}" 
                                Width="60"/>

                    <DataGridTextColumn Header="Addr" 
                                Binding="{Binding StartAddress, Mode=TwoWay}" 
                                Width="80"/>

                    <DataGridTextColumn Header="Count" 
                                Binding="{Binding Nums, Mode=TwoWay}" 
                                Width="60"/>

                    <DataGridTemplateColumn Header="Command (Hex)" Width="*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding FullCommand, Converter={StaticResource ByteArrayToHexStringConverter}}"
                                   VerticalAlignment="Center"
                                   Margin="5,0"
                                   Foreground="#333"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>

                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
    </Grid>
</UserControl>

